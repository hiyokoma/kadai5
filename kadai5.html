<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>èª²é¡Œ05</title>

    <style>
      #output {
          background: pink;
          height: 300px;
          overflow: scroll;
      }
  </style>
  </head>
  <body>
    <p>ä¿å­˜</p>

    <div id="map" style="width:620px; height:400px"></div>

    <button id="hozon">ä¿å­˜</button>

    ç·¯åº¦ï¼š<input type="text" id="lat" name="lat" value="" size="20">ã€€çµŒåº¦ï¼š<input type="text" id="lng" name="lng" value="" size="20">

    <div id="output"></div>

    <script type="text/javascript">
  // Note: This example requires that you consent to location sharing when
// prompted by your browser. If you see the error "The Geolocation service
// failed.", it means you probably did not give permission for the browser to
// locate you.
let map, infoWindow;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 35.6769883, lng: 139.7588499 },
    zoom: 14,
  });
  infoWindow = new google.maps.InfoWindow();

  const locationButton = document.createElement("button");

  locationButton.textContent = "ç¾åœ¨åœ°ã‚’è¡¨ç¤ºã™ã‚‹";
  locationButton.classList.add("custom-map-control-button");
  map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
  locationButton.addEventListener("click", () => {
    // Try HTML5 geolocation.
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };

          infoWindow.setPosition(pos);
          infoWindow.setContent("ç¾åœ¨åœ°ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ");
          infoWindow.open(map);
          map.setCenter(pos);
        },
        () => {
          handleLocationError(true, infoWindow, map.getCenter());
        }
      );
    } else {
      // Browser doesn't support Geolocation
      handleLocationError(false, infoWindow, map.getCenter());
    }
  });

  map.addListener('click', function(e) {
    clickMap(e.latLng, map);
  });
}

function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(
    browserHasGeolocation
      ? "Error: The Geolocation service failed."
      : "Error: Your browser doesn't support geolocation."
  );
  infoWindow.open(map);
}

window.initMap = initMap;

function clickMap(geo, map) {
  lat = geo.lat();
  lng = geo.lng();
 
  //å°æ•°ç‚¹ä»¥ä¸‹6æ¡ã«ä¸¸ã‚ã‚‹å ´åˆ
  //lat = Math.floor(lat * 1000000) / 1000000);
  //lng = Math.floor(lng * 1000000) / 1000000);
 
  document.getElementById('lat').value = lat;
  document.getElementById('lng').value = lng;
 
  //ä¸­å¿ƒã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  map.panTo(geo);
 
  //ãƒãƒ¼ã‚«ãƒ¼ã®æ›´æ–°
  marker.setMap(null);
  marker = null;
  marker = new google.maps.Marker({
    map: map, position: geo 
  });
  
}

    </script>


     <!--APIã‚­ãƒ¼ã€€google-->

    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=(APIKEY)&callback=initMap">
    </script>

        <!-- JQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <!-- JQuery -->
    

        <!--** ä»¥ä¸‹Firebase **-->
        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
    
            // è²¼ã‚Šä»˜ã‘ã‚‹å ´æ‰€
            import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
            // 
    
    
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
    
            // Your web app's Firebase configuration
            const firebaseConfig = {
            //APIã‚­ãƒ¼ï¼ˆfirebase)
            };
    
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
    
            // ã“ã®è¾ºã‚Šã«æ›¸ã„ã¦ã„ãã¾ã™
    
    
            const db = getDatabase(app);
            const dbRef = ref(db, 'dev245');
    
            // é€ä¿¡å‡¦ç†ã‚’è¨˜è¿°
            $('#hozon').on('click', function () {
    
              
              const msg = {
                text: lat,
                text2: lng,
              }

                // firebaseã«é€ã‚‹æº–å‚™ã‚’ã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ğŸ¤—
                const newPostRef = push(dbRef) //ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã§ãã‚‹æº–å‚™
                set(newPostRef, msg); // firebaseã®ç™»éŒ²ã§ãã‚‹å ´æ‰€ã«ä¿å­˜ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ğŸ¤—
    
                $('#text').val("");
                $('#text2').val("");
    
                // sendé€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ ã“ã®ä¸‹æ¶ˆã•ãªã„
            });
    
            $("#text").on('keydown',function (e){
    
            });
    
        //å—ä¿¡å‡¦ç†
    
       // å—ä¿¡å‡¦ç†ã‚’è¨˜è¿°
       onChildAdded(dbRef, function (data) {
                // ã“ã“ã‹ã‚‰ãŒå—ä¿¡å‡¦ç†ãŒå§‹ã¾ã‚Šã¾ã™
    
                // ç™»éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ğŸ¤—
                const msg = data.val();
                console.log(msg, 'å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®å¡Š')
                const key = data.key;
                console.log(key, 'ãƒ‡ãƒ¼ã‚¿ã®å¡Šã«ã‚¢ã‚¯ã‚»ã‚¹')
        
                // es6ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«
    

                    let e = `
                    <div class="msg">
                        <p>ç·¯åº¦ï¼š${msg.text}<br>çµŒåº¦ï¼š${msg.text2}</p>
                    </div>    
                `;
                $("#output").append(e);



    
            
                // htmlã«åŸ‹ã‚è¾¼ã¿ã¾ã—ã‚‡ã†ğŸ¤—
                // append();ã¨ã„ã†jqueryã®ãŠã¾ã˜ãªã„ã‚’ä½¿ã„ã¾ã™
                const output = document.getElementById('output');
                output.scrollTo(0, output.scrollHeight);
    
            })
        
      </script>


  </body>
</html>